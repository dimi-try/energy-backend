# ๐ Backend-ะฟัะธะปะพะถะตะฝะธะต "ะขะพะฟ ัะฝะตัะณะตัะธะบะพะฒ"

ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฒ **"ะขะพะฟ ัะฝะตัะณะตัะธะบะพะฒ"** โ backend-ะฟัะธะปะพะถะตะฝะธะต ะฝะฐ **FastAPI**, ัะพะทะดะฐะฝะฝะพะต ะดะปั ะพัะตะฝะบะธ ะธ ะฒัะฑะพัะฐ ะปัััะธั ัะฝะตัะณะตัะธัะตัะบะธั ะฝะฐะฟะธัะบะพะฒ. ะะดะตัั ะฟะพะปัะทะพะฒะฐัะตะปะธ ะผะพะณัั ะพััะฐะฒะปััั ะพัะทัะฒั, ะฒัััะฐะฒะปััั ะพัะตะฝะบะธ ะธ ะฐะฝะฐะปะธะทะธัะพะฒะฐัั ััะฐัะธััะธะบั ะฟะพะฟัะปััะฝัั ะฝะฐะฟะธัะบะพะฒ. ะัะพะตะบั ะธัะฟะพะปัะทัะตั **PostgreSQL** ะธ **Alembic** ะดะปั ะฝะฐะดะตะถะฝะพะณะพ ััะฐะฝะตะฝะธั ะธ ัะฟัะฐะฒะปะตะฝะธั ะดะฐะฝะฝัะผะธ. ๐

## ๐ ะัะฟะพะปัะทัะตะผัะต ัะตัะฝะพะปะพะณะธะธ

[![Technologies](https://skillicons.dev/icons?i=py,fastapi,postgres)](https://skillicons.dev)

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```sh
energy-backend/
โ
โโโ .github/
โ   โโโ workflows/
โ       โโโ docker-deploy.yml   # CI/CD: ะดะตะฟะปะพะน Docker-ะบะพะฝัะตะนะฝะตัะฐ
โ
โโโ alembic/
โ   โโโ versions/               # ะะฐะฟะบะฐ ั ะผะธะณัะฐัะธัะผะธ
โ   โโโ env.py                  # ะะพะฝัะธะณััะฐัะธั Alembic
โ
โโโ app/        
โ   โโโ api/
โ   โ   โโโ v1/
โ   โ   โ   โโโ endpoints/
โ   โ   โ   โ   โโโ __init__.py # ะะฝะธัะธะฐะปะธะทะฐัะธั ะผะพะดัะปั Python
โ   โ   โ   โ   โโโ ... .py     # ะะพััั API (ัะฝะดะฟะพะธะฝัั)
โ   โ   โ   โโโ __init__.py     # ะะฝะธัะธะฐะปะธะทะฐัะธั ะผะพะดัะปั Python
โ   โ   โ   โโโ router.py       # ะะฑัะตะดะธะฝัะตั ะผะฐัััััั ะฒะตััะธะธ v1
โ   โ   โโโ __init__.py         # ะะฝะธัะธะฐะปะธะทะฐัะธั ะผะพะดัะปั Python
โ   โโโ core/           
โ   โ   โโโ __init__.py         # ะะฝะธัะธะฐะปะธะทะฐัะธั ะผะพะดัะปั Python
โ   โ   โโโ config.py           # ะะพะฝัะธะณััะฐัะธั ะฟัะธะปะพะถะตะฝะธั
โ   โ   โโโ security.py         # ะะพะณะธะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ (JWT, ะฒะฐะปะธะดะฐัะธั)
โ   โโโ db/
โ   โ   โโโ models/
โ   โ   โ   โโโ __init__.py     # ะะฝะธัะธะฐะปะธะทะฐัะธั ะผะพะดัะปั Python
โ   โ   โ   โโโ base.py         # ะะฐะทะพะฒัะน ะบะปะฐัั ะดะปั ะผะพะดะตะปะตะน
โ   โ   โ   โโโ ... .py         # SQLAlchemy ะผะพะดะตะปะธ
โ   โ   โโโ __init__.py         # ะะฝะธัะธะฐะปะธะทะฐัะธั ะผะพะดัะปั Python
โ   โ   โโโ database.py         # ะะฐัััะพะนะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะะ
โ   โโโ schemas/        
โ   โ   โโโ __init__.py         # ะะฝะธัะธะฐะปะธะทะฐัะธั ะผะพะดัะปั Python
โ   โ   โโโ ... .py             # Pydantic ััะตะผั
โ   โโโ services/       
โ   โ   โโโ __init__.py         # ะะฝะธัะธะฐะปะธะทะฐัะธั ะผะพะดัะปั Python
โ   โ   โโโ ... .py             # CRUD ะพะฟะตัะฐัะธะธ (ะะธะทะฝะตั ะปะพะณะธะบะฐ)
โ   โโโ test/
โ   โ   โโโ __init__.py         # ะะฝะธัะธะฐะปะธะทะฐัะธั ะผะพะดัะปั Python
โ   โ   โโโ load_test_data.py   # ะกะบัะธะฟั ะทะฐะณััะทะบะธ ัะตััะพะฒัั ะดะฐะฝะฝัั (ะฒะบะปััะฐะตั ะผะธะณัะฐัะธะธ)
โ   โโโ __init__.py             # ะะฝะธัะธะฐะปะธะทะฐัะธั ะผะพะดัะปั Python
โ   โโโ main.py                 # ะขะพัะบะฐ ะฒัะพะดะฐ FastAPI
โ
โโโ .dockerignore               # ะัะบะปััะตะฝะธั ะดะปั ัะฑะพัะบะธ ะบะพะฝัะตะนะฝะตัะฐ
โโโ .env.sample                 # ะัะธะผะตั ัะฐะนะปะฐ ั ะฟะตัะตะผะตะฝะฝัะผะธ ะพะบััะถะตะฝะธั
โโโ .gitignore                  # ะัะบะปััะฐะตะผัะต ัะฐะนะปั
โโโ alembic.ini                 # ะคะฐะนะป ะบะพะฝัะธะณััะฐัะธะธ Alembic
โโโ docker-compose-server.yml   # ะะพะฝัะธะณััะฐัะธั Docker ั PostgreSQL ะดะปั ัะตัะฒะตัะฐ
โโโ docker-compose.yml          # ะะพะฝัะธะณััะฐัะธั Docker
โโโ Dockerfile                  # Docker ะบะพะฝัะธะณััะฐัะธั
โโโ README.md                   # ะะพะบัะผะตะฝัะฐัะธั
โโโ requirements.txt            # ะะฐะฒะธัะธะผะพััะธ ะฟัะพะตะบัะฐ
โโโ test_data.csv               # ะขะตััะพะฒัะต ะดะฐะฝะฝัะต
```

---

## โก ะฃััะฐะฝะพะฒะบะฐ ะธ ะทะฐะฟััะบ

### 1๏ธโฃ ะะพะดะณะพัะพะฒะบะฐ ะพะบััะถะตะฝะธั

#### ๐ ะะฐัััะพะนะบะฐ .env
ะกะบะพะฟะธััะนัะต `.env.sample`, ะฟะตัะตะธะผะตะฝัะนัะต ะฒ `.env` ะธ ะดะพะฑะฐะฒััะต ัะฒะพะธ ะดะฐะฝะฝัะต.

#### ๐ง ะกะพะทะดะฐะฝะธะต ะธ ะฐะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั

ะกะพะทะดะฐะฝะธะต 
```bash
python -m venv venv
```
ะะบัะธะฒะฐัะธั
```bash
venv\Scripts\activate  # Windows
```
```bash
source venv/bin/activate  # Linux/macOS
```

#### ๐ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
```bash
pip install -r requirements.txt
```

### 2๏ธโฃ ะะฐะฟััะบ Backend

#### ๐ ะะฒัะพะผะฐัะธัะตัะบะฐั ะฟะพะดะณะพัะพะฒะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั ะธ ะผะธะณัะฐัะธะน
ะัะฟะพะปะฝะธัะต ะบะพะผะฐะฝะดั ะดะปั ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะฑะฐะทั ะดะฐะฝะฝัั, ะฟัะธะผะตะฝะตะฝะธั ะผะธะณัะฐัะธะน ะธ ะทะฐะณััะทะบะธ ัะตััะพะฒัั ะดะฐะฝะฝัั:
```bash
python -m app.test.load_test_data
```

#### ๐ ะะฐะฟััะบ ัะตัะฒะตัะฐ FastAPI
```bash
uvicorn app.main:app --reload
```

API ะฑัะดะตั ะดะพัััะฟะฝะพ ะฟะพ ะฐะดัะตัั:  
๐ `http://localhost:8000`

---

## ๐ ะะตะฟะปะพะน

ะะพัััะฟะฝั ะดะฒะฐ ัะฟะพัะพะฑะฐ:

### ะะฐัะธะฐะฝั 1: Docker Compose ะฒัััะฝัั

1.  ะัะพะฒะตัััะต `docker-compose.yml`
    
2.  ะัะฟะพะปะฝะธัะต ัะฑะพัะบั ะธ ะฟัั:
    

```sh
docker compose build
```
```sh
docker compose up -d
```
```sh
docker push <your-dockerhub>
```

### ะะฐัะธะฐะฝั 2: ะะฒัะพะผะฐัะธัะตัะบะธ ัะตัะตะท GitHub Actions

1.  ะ ัะฐะนะปะต `.github/workflows/docker-deploy.yml` ัะถะต ะฒัั ะณะพัะพะฒะพ
    
2.  ะัะธ ะฟััะต ะฒ `main` ะฒะตัะบั ะฟัะพะธะทะพะนะดัั ะฐะฒัะพะผะฐัะธัะตัะบะฐั ัะฑะพัะบะฐ ะธ ะฟัะฑะปะธะบะฐัะธั ะพะฑัะฐะทะฐ ะฒ DockerHub
    

ะะฐ ะฟัะพะด-ัะตัะฒะตัะต ะผะพะถะตัะต ะธัะฟะพะปัะทะพะฒะฐัั `docker-compose-server.yml` ะธะท [ัะตะฟะพะทะธัะพัะธั backend](https://github.com/dimi-try/energy-backend). ะกะบะพะฟะธััะนัะต `.env.example`, ะฟะตัะตะธะผะตะฝัะนัะต ะฒ `.env` ะธ ะดะพะฑะฐะฒััะต ัะฒะพะธ ะดะฐะฝะฝัะต.

#### ๐ ะะฒัะพะผะฐัะธัะตัะบะฐั ะฟะพะดะณะพัะพะฒะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั ะธ ะผะธะณัะฐัะธะน
ะัะปะธ ะฒะฐะผ ะฝัะถะฝะพ ะฟะพะผะตะฝััั ัะตััะพะฒัะต ะดะฐะฝะฝัะต ะฝะฐ ัะตัะฒะตัะต, ัะพ ะฒั ะผะพะถะตัะต ัะดะตะปะฐัั ัะปะตะดัััะตะต:

ะะพะนัะธ ะฒ ะบะพะฝัะตะนะฝะตั
```
docker exec -it energy-backend-1 /bin/sh
```

ะฃััะฐะฝะพะฒะธัั nano (ะฟะพ ะถะตะปะฐะฝะธั, ะตัะปะธ ะฒะฐะผ ัะดะพะฑะฝะตะต ะฟะพะปัะทะพะฒะฐัััั nano):
```
apk add --no-cache nano   # ะตัะปะธ ะบะพะฝัะตะนะฝะตั ะฝะฐ Alpine
```
ะธะปะธ
```
apt-get update && apt-get install -y nano   # ะตัะปะธ Debian/Ubuntu
```

ะะฐะผะตะฝะธัั ัะตััะพะฒัะต ะดะฐะฝะฝัะต ะฝะฐ ัะฒะพะธ
```
nano test_data.csv
```

ะัะปะธ ะฟะฐะฟะบะธ versions ะฝะตั, ัะพะทะดะฐัั ะตะต:
```
mkdir -p /app/alembic/versions
```

ะะฐะฟัััะธัั ัะบัะธะฟั ะทะฐะณััะทะบะธ ัะตััะพะฒัั ะดะฐะฝะฝัั
```
python -m app.test.load_test_data
```

---
## ๐ผ ะะตะทะตัะฒะฝะพะต ะบะพะฟะธัะพะฒะฐะฝะธะต ะธะทะพะฑัะฐะถะตะฝะธะน

### ๐ค ะัะณััะทะบะฐ ะธะทะพะฑัะฐะถะตะฝะธะน ะธะท ะบะพะฝัะตะนะฝะตัะฐ

1. ะัะพะฒะตัะธัั, ัััะตััะฒัะตั ะปะธ ะฟะฐะฟะบะฐ ั ะธะทะพะฑัะฐะถะตะฝะธัะผะธ ัะถะต ะฝะฐ ัะตัะฒะตัะต
```
find / -type d -name "image-backup" 2>/dev/null
```

2. ะกะบะพะฟะธัะพะฒะฐัั ะฟะฐะฟะบั uploads ะธะท ะบะพะฝัะตะนะฝะตัะฐ ะฝะฐ ัะตัะฒะตั
```
docker cp energy-backend-1:/app/uploads /image-backup/
```

3. ะกะบะพะฟะธัะพะฒะฐัั ั ัะตัะฒะตัะฐ ะฝะฐ ะปะพะบะฐะปัะฝัั ะผะฐัะธะฝั

๐ Linux/macOS:
```
scp -r user@server:/image-backup/ ~/Downloads/
```

๐ Windows (PowerShell):
```
scp -r user@server:/image-backup/ C:\Users\USER\Downloads\
```

4. ะัะธััะธัั ะฒัะตะผะตะฝะฝัั ะฟะฐะฟะบั ะฝะฐ ัะตัะฒะตัะต
```
rm -rf /image-backup/
```
5. ะัะพะฒะตัะธัั, ะพััะฐะปะฐัั ะปะธ ะฟะฐะฟะบะฐ ะฝะฐ ัะตัะฒะตัะต
```
find / -type d -name "image-backup" 2>/dev/null
```

### ๐ฅ ะะฐะณััะทะบะฐ ะธะทะพะฑัะฐะถะตะฝะธะน ะพะฑัะฐัะฝะพ ะฒ ะบะพะฝัะตะนะฝะตั

1. ะัะพะฒะตัะธัั, ัััะตััะฒัะตั ะปะธ ะฟะฐะฟะบะฐ ั ะธะทะพะฑัะฐะถะตะฝะธัะผะธ ัะถะต ะฝะฐ ัะตัะฒะตัะต
```
find / -type d -name "image-backup" 2>/dev/null
```
2. ะกะบะพะฟะธัะพะฒะฐัั ะธะทะพะฑัะฐะถะตะฝะธั ั ะปะพะบะฐะปะบะธ ะฝะฐ ัะตัะฒะตั

๐ Linux/macOS:
```
scp -r ~/Downloads/image-backup/ user@server:/image-backup/
```

๐ Windows (PowerShell):
```
scp -r C:\Users\USER\Downloads\image-backup\ user@server:/image-backup/
```
3. ะะตัะตะฝะตััะธ ะธะทะพะฑัะฐะถะตะฝะธั ั ัะตัะฒะตัะฐ ะฒ ะบะพะฝัะตะนะฝะตั
```
docker cp /image-backup/uploads energy-backend-1:/app/
```
4. ะัะธััะธัั ะฒัะตะผะตะฝะฝัั ะฟะฐะฟะบั ะฝะฐ ัะตัะฒะตัะต
```
rm -rf /image-backup/
```
5. ะัะพะฒะตัะธัั, ะพััะฐะปะฐัั ะปะธ ะฟะฐะฟะบะฐ ะฝะฐ ัะตัะฒะตัะต
```
find / -type d -name "image-backup" 2>/dev/null
```

---
## ๐ ะะตะทะตัะฒะฝะพะต ะบะพะฟะธัะพะฒะฐะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั

### ๐ค ะกะพะทะดะฐะฝะธะต ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ

1. ะัะพะฒะตัะธัั, ัััะตััะฒัะตั ะปะธ ะฑัะบะฐะฟ ัะถะต ะฝะฐ ัะตัะฒะตัะต
```
find / -type f -name "*energy_drink*" 2>/dev/null
```

2๏ธ. ะะฐัะพะดะธะผ ะฒ ะบะพะฝัะตะนะฝะตั ั PostgreSQL:

```
docker exec -it energy-postgres-1 bash
```

3๏ธ. ะะตะปะฐะตะผ ะดะฐะผะฟ ะฑะฐะทั:

```
pg_dump -U postgres -d energy_drinks_db -Fc > /backup_db/energy_drinks_db_backup.dump
```

4๏ธ. ะััะพะดะธะผ ะธะท ะบะพะฝัะตะนะฝะตัะฐ:

```
exit
```

5๏ธ. ะะพะฟะธััะตะผ ะดะฐะผะฟ ะธะท ะบะพะฝัะตะนะฝะตัะฐ ะฝะฐ ัะตัะฒะตั:

```
docker cp energy-postgres-1:/backup_db/energy_drinks_db_backup.dump /backup_db/energy_drinks_db_backup.dump
```

6๏ธ. ะััะพะดะธะผ ั ัะตัะฒะตัะฐ:

```
exit
```

7๏ธ. ะกะบะฐัะธะฒะฐะตะผ ะดะฐะผะฟ ะฝะฐ ะปะพะบะฐะปัะฝัั ะผะฐัะธะฝั:

๐ Windows (PowerShell):

```
scp user@server:/backup_db/energy_drinks_db_backup.dump C:\Users\USER\Downloads\backup_db\energy_drinks_db_backup.dump
```

๐ Linux/macOS:

```
scp user@server:/backup_db/energy_drinks_db_backup.dump ./backup_db/energy_drinks_db_backup.dump
```

8๏ธ. ะะพะดะบะปััะฐะตะผัั ัะฝะพะฒะฐ ะบ ัะตัะฒะตัั ะธ ัะธััะธะผ ะฒัะตะผะตะฝะฝัะต ัะฐะนะปั:

ะฃะดะฐะปัะตะผ ะฑัะบะฐะฟ ะฝะฐ ัะตัะฒะตัะต:
``` 
rm /backup_db/energy_drinks_db_backup.dump  
``` 
ะะฐัะพะดะธะผ ะฒ ะบะพะฝัะตะนะฝะตั
``` 
docker exec energy-postgres-1 
```
ะฃะดะฐะปัะตะผ ะฑัะบะฐะฟ ั ะบะพะฝัะตะนะฝะตัะฐ
```
rm /backup_db/energy_drinks_db_backup.dump
```

---

### ๐ฅ ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะธะท ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ

1๏ธโฃ ะะฐะณััะถะฐะตะผ ะดะฐะผะฟ ะฝะฐ ัะตัะฒะตั:

๐ Windows (PowerShell):

```
scp C:\Users\USER\Downloads\backup_db\energy_drinks_db_backup.dump user@server:/backup_db/energy_drinks_db_backup.dump
```

๐ Linux/macOS:

```
scp ./backup_db/energy_drinks_db_backup.dump user@server:/backup_db/energy_drinks_db_backup.dump
```

2๏ธโฃ ะะพะฟะธััะตะผ ะดะฐะผะฟ ะฒ ะบะพะฝัะตะนะฝะตั:

```
docker cp /backup_db/energy_drinks_db_backup.dump energy-postgres-1:/backup_db/energy_drinks_db_backup.dump
```

3๏ธโฃ ะฃะดะฐะปัะตะผ ััะฐััั ะฑะฐะทั ะธ ัะพะทะดะฐัะผ ะฝะพะฒัั:

```
docker exec -it energy-postgres-1 psql -U postgres -c "DROP DATABASE IF EXISTS energy_drinks_db; CREATE DATABASE energy_drinks_db;"
```

4๏ธโฃ ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฑะฐะทั ะธะท ะดะฐะผะฟะฐ:

```
docker exec -i energy-postgres-1 pg_restore -U postgres -d energy_drinks_db --verbose /backup_db/energy_drinks_db_backup.dump
```

---

## ๐ก ะะฝัะตะณัะฐัะธั ั frontend

Backend ัะฐะฑะพัะฐะตั ะฒ ัะฒัะทะบะต ั frontend-ะฟัะธะปะพะถะตะฝะธะตะผ [energy-frontend](https://github.com/dimi-try/energy-frontend).  
ะฃะฑะตะดะธัะตัั, ััะพ:

-   `REACT_APP_BACKEND_URL` ัะบะฐะทัะฒะฐะตั ะฝะฐ ะบะพััะตะบัะฝัะน ัะพัั backend-ะฐ,
    
-   ัะฐะทัะตัะตะฝะพ CORS-ัะพะตะดะธะฝะตะฝะธะต ั ััะพะฝัะฐ.
    

---

## ๐ ะะฐะฑะพัะฐ ั Alembic

Alembic ะธัะฟะพะปัะทัะตััั ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะผะธะณัะฐัะธัะผะธ ะฑะฐะทั ะดะฐะฝะฝัั.

### ะัะฝะพะฒะฝัะต ะบะพะผะฐะฝะดั:

- ๐ **ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะน ะผะธะณัะฐัะธะธ:**
  ```bash
  alembic revision --autogenerate -m "ะะฟะธัะฐะฝะธะต ะธะทะผะตะฝะตะฝะธะน"
  ```
- ๐ **ะัะธะผะตะฝะตะฝะธะต ะผะธะณัะฐัะธะน:**
  ```bash
  alembic upgrade head
  ```
- ๐ **ะัะบะฐั ะผะธะณัะฐัะธะธ:**
  ```bash
  alembic downgrade -1
  ```

---
## ๐ ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั

๐ **ะัะพัะผะพัั ัััะฐะฝะพะฒะปะตะฝะฝัั ะทะฐะฒะธัะธะผะพััะตะน**
```bash
pip list
```

๐พ **ะกะพััะฐะฝะตะฝะธะต ะทะฐะฒะธัะธะผะพััะตะน**
```bash
pip freeze > requirements.txt
```

๐ **ะฃะดะฐะปะตะฝะธะต ะฒัะตั ะทะฐะฒะธัะธะผะพััะตะน**
```bash
pip uninstall -y -r requirements.txt
```

๐งน **ะฃะดะฐะปะตะฝะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั venv**
```powershell
Get-ChildItem -Path . -Recurse -Directory -Filter "venv" | Remove-Item -Recurse -Force #windows
```

๐งน **ะฃะดะฐะปะตะฝะธะต ะบะตัะฐ pycache**
```powershell
Get-ChildItem -Recurse -Directory -Include "__pycache__", ".mypy_cache", ".pytest_cache" | Remove-Item -Recurse -Force #windows
Get-ChildItem -Recurse -Include *.pyc | Remove-Item -Force #windows
```

---

๐ก **ะัะปะธ ั ะฒะฐั ะตััั ะฒะพะฟัะพัั ะธะปะธ ะฟัะตะดะปะพะถะตะฝะธั ะฟะพ ัะปัััะตะฝะธั ะฟัะพะตะบัะฐ, ัะพะทะดะฐะนัะต issue!** ๐
